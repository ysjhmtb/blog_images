# 스프링 프레임워크 입문

<br>

## [Spring PetClinic Sample Application](https://github.com/spring-projects/spring-petclinic)

<br>

## IoC 소개

- 무엇이 뒤바낀 것인가? 의존성에 대한 제어가 뒤바뀐 것이다.

```java
@Controller
class OwnerController {

    private static final String VIEWS_OWNER_CREATE_OR_UPDATE_FORM = "owners/createOrUpdateOwnerForm";
    private final OwnerRepository owners;

	// OwnerRepository와 OwnerController는 의존성 관계.
  // OwnerController에게 OwnerRepository는 반드시 필요한데, 이를 누가 만들고 관리하나?
  // IoC가 없다면 new OwnerRepository()를 사용했을 것이다. 내가 안 만들고 밖에서 누군가가
  // 제공해주면 IoC라고 부른다.
    public OwnerController(OwnerRepository clinicService) {
        this.owners = clinicService;
    }

}

```

<br>

- 의존성 주입.

```java
class OwnerControllerTest{
  @Test
  public void create(){
    // new OwnerController(repo)을 의존성 주입이라고 한다.
    OwnerRepository repo = new OwnerRepository();
    OwnerController controller = new OwnerController(repo);
  }
}
```

<br>

## IoC 컨테이너

<br>

- ApplicationContext라는 interface가 있으며 IoC 컨테이너라 불리운다. 이 IoC 컨테이너를 직접 쓸 일은 별로 없다.
- IoC 컨테이너는 IoC를 사용하는 코드를 동작하게 만들어 준다.
- 컨테이너 내부의 객체들을 빈이라 부른다. 컨테이너는 이런 빈들의 의존성들을 관리해 준다.
- OwnerContoller와 OwnerRepository는 모두 빈이다. 따라서 이들의 의존성은 IoC 컨테이너가 관리해 준다. 오로지 빈만 관리해 줄 수 있다.
- Bean 인지 어떻게 알 수 있을까? IntelliJ에서 class의 왼쪽을 보면 녹색 작은 콩이 보이면 Bean 이다. @Controller @Component @Service @Repository 같은 annotation이 붙어있으면 Bean으로 등록된다.

<br>

## 빈(Bean)

<br>

스프링 IoC 컨테이너가 관리하는 객체.

<br>

- 빈의 등록 : 1) Component Scanning: @Component @Repository @Service @Controller 2) 또는 직접 XML이나 자바 설정 파일에 등록.
- @Controller의 코드를 열어보면 @Component가 붙어있는 것을 알 수 있다. 그래서 빈으로 등록된다.
- 직접 등록하는 방법은 @Bean을 붙이는 것이다.

```java
@SpringBootApplication
public class PetClinicApplication{
  
  // @Bean이라는 애너테이션을 갖는 메소드를 정의할 때는 항상 @Configuration이라는 애너테이션을 갖는 클래스 안에서 해야 한다. @SpringBootApplication 안에 @Configuration 존재.
  @Bean
  public String keesun(){
    return "keesun";
  }
  
   public static void main(String[] args) {
        SpringApplication.run(PetClinicApplication.class, args);
    }
}
```

- Bean을 꺼내 사용하는 방법.

```java
@RestController
public class SampleController{
    
  // 빈을 가져다 사용하기
  @Autowired
  String keesun;
  
  @GetMapping("/context")
  public String context(){
    return "hello " + keesun;
  }
  
}
```

<br>

## 의존성 주입(Dependency Injection)

<br>

- Bean이 되는 클래스에 생성자가 오직 하나만 있고, 그 생성자의 매개변수 타입이 Bean으로 등록이 되어 있다면, @Autowired가 없더라도 Bean으로 주입을 해준다. 

- @Autowired / @Inject를 어디에 붙일까? 어떠한 클래스에 반드시 필요한 의존성이라면 생성자를 추천하고, 이 클래스가 이 의존성에 대한 Setter를 가지고 있다면 Setter를 추천하며, Setter가 없다면 필드에 붙이는 것을 추천.

<br>

## AOP 소개

<br>

- 흩어진 코드를 한 곳으로 모으자.

<br>

## AOP 적용 예제

<br>

```java
// 메서드에 붙일 용도
@Target(ElementType.METHOD)
// Runtime동안 유지
@Retention(RetentionPolicy.RUNTIME)
public @interface LogExecutionTime{
  
}
```

<br>

```java
@RestController
public class SampleController{
    
  // 빈을 가져다 사용하기
  @Autowired
  String keesun;
  
  @LogExecutionTime
  @GetMapping("/context")
  public String context(){
    return "hello " + keesun;
  }
  
} 
```

<br>

```java
/*
 * Copyright 2012-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.springframework.samples.petclinic.owner;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.servlet.ModelAndView;

import javax.validation.Valid;
import java.util.Collection;
import java.util.Map;

/**
 * @author Juergen Hoeller
 * @author Ken Krebs
 * @author Arjen Poutsma
 * @author Michael Isvy
 */
@Controller
class OwnerController {

    private static final String VIEWS_OWNER_CREATE_OR_UPDATE_FORM = "owners/createOrUpdateOwnerForm";
    private final OwnerRepository owners;


    public OwnerController(OwnerRepository clinicService) {
        this.owners = clinicService;
    }

    @InitBinder
    public void setAllowedFields(WebDataBinder dataBinder) {
        dataBinder.setDisallowedFields("id");
    }

  	@LogExecutionTime
    @GetMapping("/owners/new")
    public String initCreationForm(Map<String, Object> model) {
        Owner owner = new Owner();
        model.put("owner", owner);
        return VIEWS_OWNER_CREATE_OR_UPDATE_FORM;
    }

    @LogExecutionTime
    @PostMapping("/owners/new")
    public String processCreationForm(@Valid Owner owner, BindingResult result) {
        if (result.hasErrors()) {
            return VIEWS_OWNER_CREATE_OR_UPDATE_FORM;
        } else {
            this.owners.save(owner);
            return "redirect:/owners/" + owner.getId();
        }
    }

    @GetMapping("/owners/find")
    public String initFindForm(Map<String, Object> model) {
        model.put("owner", new Owner());
        return "owners/findOwners";
    }
	
  	@LogExecutionTime
    @GetMapping("/owners")
    public String processFindForm(Owner owner, BindingResult result, Map<String, Object> model) {

        // allow parameterless GET request for /owners to return all records
        if (owner.getLastName() == null) {
            owner.setLastName(""); // empty string signifies broadest possible search
        }

        // find owners by last name
        Collection<Owner> results = this.owners.findByLastName(owner.getLastName());
        if (results.isEmpty()) {
            // no owners found
            result.rejectValue("lastName", "notFound", "not found");
            return "owners/findOwners";
        } else if (results.size() == 1) {
            // 1 owner found
            owner = results.iterator().next();
            return "redirect:/owners/" + owner.getId();
        } else {
            // multiple owners found
            model.put("selections", results);
            return "owners/ownersList";
        }
    }

    @GetMapping("/owners/{ownerId}/edit")
    public String initUpdateOwnerForm(@PathVariable("ownerId") int ownerId, Model model) {
        Owner owner = this.owners.findById(ownerId);
        model.addAttribute(owner);
        return VIEWS_OWNER_CREATE_OR_UPDATE_FORM;
    }

    @PostMapping("/owners/{ownerId}/edit")
    public String processUpdateOwnerForm(@Valid Owner owner, BindingResult result, @PathVariable("ownerId") int ownerId) {
        if (result.hasErrors()) {
            return VIEWS_OWNER_CREATE_OR_UPDATE_FORM;
        } else {
            owner.setId(ownerId);
            this.owners.save(owner);
            return "redirect:/owners/{ownerId}";
        }
    }

    /**
     * Custom handler for displaying an owner.
     *
     * @param ownerId the ID of the owner to display
     * @return a ModelMap with the model attributes for the view
     */
    @GetMapping("/owners/{ownerId}")
    public ModelAndView showOwner(@PathVariable("ownerId") int ownerId) {
        ModelAndView mav = new ModelAndView("owners/ownerDetails");
        mav.addObject(this.owners.findById(ownerId));
        return mav;
    }

}

```

<br>

이렇게 네군데에 @LogExecutionTime를 붙임.

<br>

@LogExecutionTime 은 주석일 뿐이고 다음과 같은 클래스가 필요함.

<br>

```java
@Component
@Aspect
public class LogAspect{
  
  Logger logger = LoggerFactory.getLogger(LogAspect.class);
  
  @Around("@annotation(LogExecutionTime)")
  public Object logExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable{
    StopWatch stopWatch = new StopWatch();
    stopWatch.start();
    
    Object ret = joinPoint.proceed();
    
    stopWatch.stop();
    logger.info(stopWatch.prettyPrint());
    
    return ret;    
  }
}
```

<br>

## PSA 소개

<br>

- PSA = 잘 만든 인터페이스

<br>

